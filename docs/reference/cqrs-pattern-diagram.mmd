%%{init: {'theme':'base', 'themeVariables': {'primaryColor':'#f0f9ff', 'primaryTextColor':'#0c4a6e', 'primaryBorderColor':'#0284c7', 'lineColor':'#0ea5e9', 'secondaryColor':'#7dd3fc', 'tertiaryColor':'#bae6fd'}}}%%
graph LR
    subgraph "Client Request"
        CLIENT[Client Application]
    end

    subgraph "Command Side - Write Operations"
        API_CMD[API Service<br/>Command Handler]
        DOMAIN_CMD[Domain Aurora<br/>Command Side]
        AURORA_CMD[(Aurora MySQL<br/>Command Side<br/>TSID Primary Key<br/>높은 정규화 3NF<br/>Soft Delete<br/>History Tables)]
    end

    subgraph "Event Streaming"
        KAFKA_EVENT[Apache Kafka<br/>Event Broker<br/>Topics:<br/>- user-events<br/>- archive-events<br/>- contest-events<br/>- news-events]
    end

    subgraph "Query Side - Read Operations"
        API_QRY[API Service<br/>Query Handler]
        DOMAIN_QRY[Domain MongoDB<br/>Query Side]
        MONGO_QRY[(MongoDB Atlas<br/>Query Side<br/>읽기 최적화<br/>비정규화 구조<br/>ESR 인덱스<br/>프로젝션)]
    end

    subgraph "Synchronization"
        CONSUMER[Kafka Consumer<br/>Event Consumer<br/>Idempotency Check<br/>Redis 기반]
        REDIS_SYNC[(Redis<br/>멱등성 보장<br/>TTL: 7 days)]
    end

    subgraph "Cache Layer"
        REDIS_CACHE[(Redis<br/>캐싱<br/>세션 관리)]
    end

    %% Write Flow
    CLIENT -->|"1. Write Request<br/>(POST, PUT, DELETE)"| API_CMD
    API_CMD -->|"2. Command Processing"| DOMAIN_CMD
    DOMAIN_CMD -->|"3. Write to DB<br/>(TSID 생성)"| AURORA_CMD
    AURORA_CMD -->|"4. History Table<br/>(자동 저장)"| AURORA_CMD
    DOMAIN_CMD -->|"5. Publish Event<br/>(Kafka Producer)"| KAFKA_EVENT
    KAFKA_EVENT -->|"6. Event Consumption"| CONSUMER
    CONSUMER -->|"7. Check Idempotency"| REDIS_SYNC
    CONSUMER -->|"8. Sync to MongoDB<br/>(TSID 매핑)"| DOMAIN_QRY
    DOMAIN_QRY -->|"9. Write Document"| MONGO_QRY
    CONSUMER -->|"10. Mark Processed"| REDIS_SYNC
    API_CMD -->|"11. Response"| CLIENT

    %% Read Flow
    CLIENT -->|"1. Read Request<br/>(GET)"| API_QRY
    API_QRY -->|"2. Check Cache"| REDIS_CACHE
    REDIS_CACHE -->|"3. Cache Miss"| DOMAIN_QRY
    DOMAIN_QRY -->|"4. Query MongoDB<br/>(읽기 최적화)"| MONGO_QRY
    MONGO_QRY -->|"5. Return Document"| DOMAIN_QRY
    DOMAIN_QRY -->|"6. Update Cache"| REDIS_CACHE
    DOMAIN_QRY -->|"7. Return Data"| API_QRY
    API_QRY -->|"8. Response"| CLIENT

    %% Styling
    style AURORA_CMD fill:#eff6ff,stroke:#1e3a8a,stroke-width:3px,color:#1e3a8a
    style MONGO_QRY fill:#f0fdf4,stroke:#166534,stroke-width:3px,color:#166534
    style KAFKA_EVENT fill:#fef3c7,stroke:#d97706,stroke-width:3px,color:#92400e
    style REDIS_SYNC fill:#fee2e2,stroke:#dc2626,stroke-width:2px,color:#991b1b
    style REDIS_CACHE fill:#fee2e2,stroke:#dc2626,stroke-width:2px,color:#991b1b
    style DOMAIN_CMD fill:#dbeafe,stroke:#3b82f6,stroke-width:2px,color:#1e3a8a
    style DOMAIN_QRY fill:#dcfce7,stroke:#22c55e,stroke-width:2px,color:#166534
    style CONSUMER fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#92400e
    style API_CMD fill:#e0e7ff,stroke:#6366f1,stroke-width:2px,color:#312e81
    style API_QRY fill:#e0e7ff,stroke:#6366f1,stroke-width:2px,color:#312e81



