%%{init: {'theme':'base', 'themeVariables': {'primaryColor':'#f0f9ff', 'primaryTextColor':'#0c4a6e', 'primaryBorderColor':'#0284c7', 'lineColor':'#0ea5e9', 'secondaryColor':'#7dd3fc', 'tertiaryColor':'#bae6fd'}}}%%
sequenceDiagram
    participant Client
    participant API as API Service
    participant Domain as Domain Aurora<br/>(Command Side)
    participant Aurora as Aurora MySQL<br/>(Writer)
    participant Publisher as Event Publisher
    participant Kafka as Kafka Broker
    participant Consumer as Event Consumer
    participant Redis as Redis<br/>(Idempotency)
    participant MongoDomain as Domain MongoDB<br/>(Query Side)
    participant Mongo as MongoDB Atlas<br/>(Query Side)

    Note over Client,Mongo: Write Operation Flow (CQRS Command Side)
    
    Client->>API: POST /api/v1/archives<br/>(Create Archive)
    API->>Domain: ArchiveService.create()
    Domain->>Aurora: INSERT INTO archives<br/>(TSID Primary Key)
    Aurora-->>Domain: Archive Entity<br/>(id: TSID)
    Domain->>Aurora: INSERT INTO archive_history<br/>(operation_type: INSERT)
    
    Note over Publisher,Kafka: Event Publishing
    Domain->>Publisher: publish(ArchiveCreatedEvent)
    activate Publisher
    Publisher->>Kafka: Send Event<br/>(topic: archive-events<br/>partitionKey: userId)
    Kafka-->>Publisher: Acknowledgment
    deactivate Publisher
    Publisher-->>Domain: Event Published
    
    Domain-->>API: Archive Created
    API-->>Client: 201 Created<br/>(Archive Response)

    Note over Kafka,Mongo: Event Consumption & Synchronization
    
    Kafka->>Consumer: Consume Event<br/>(ArchiveCreatedEvent)
    activate Consumer
    Consumer->>Redis: Check Event Processed<br/>(eventId)
    Redis-->>Consumer: Not Processed
    
    Consumer->>MongoDomain: Sync ArchiveDocument<br/>(archiveTsid: TSID)
    activate MongoDomain
    MongoDomain->>Mongo: Insert ArchiveDocument<br/>(archiveTsid, userId, itemType, itemId)
    Mongo-->>MongoDomain: Document Created
    deactivate MongoDomain
    
    Consumer->>Redis: Mark Event Processed<br/>(TTL: 7 days)
    Redis-->>Consumer: Acknowledged
    Consumer->>Kafka: Acknowledge Offset
    deactivate Consumer

    Note over Client,Mongo: Read Operation Flow (CQRS Query Side)
    
    Client->>API: GET /api/v1/archives<br/>(List Archives)
    API->>MongoDomain: ArchiveRepository.findByUserId()
    MongoDomain->>Mongo: Query ArchiveDocument<br/>(userId index)
    Mongo-->>MongoDomain: ArchiveDocument List
    MongoDomain-->>API: Archive List
    API-->>Client: 200 OK<br/>(Archive List)

    Note over Client,Mongo: Synchronization Delay Target: < 1 second



