%%{init: {'theme':'base', 'themeVariables': {'primaryColor':'#f0f9ff', 'primaryTextColor':'#0c4a6e', 'primaryBorderColor':'#0284c7', 'lineColor':'#0ea5e9', 'secondaryColor':'#7dd3fc', 'tertiaryColor':'#bae6fd'}}}%%
graph TB
    subgraph "Client Layer"
        WEB[Web Client]
        MOBILE[Mobile Client]
    end

    subgraph "API Gateway Layer"
        GATEWAY[API Gateway<br/>Spring Boot 4.0.1<br/>라우팅 및 인증]
    end

    subgraph "API Services Layer"
        AUTH_API[API Auth<br/>JWT + OAuth 2.0<br/>Google/Naver/Kakao]
        CONTEST_API[API Contest<br/>대회 정보]
        NEWS_API[API News<br/>뉴스 정보]
        ARCHIVE_API[API Archive<br/>사용자 아카이브]
        CHATBOT_API[API Chatbot<br/>LangChain4j RAG<br/>기반 챗봇]
    end

    subgraph "Application Layer"
        AUTH_SVC[Auth Service<br/>OAuth Provider Factory]
        CONTEST_SVC[Contest Service]
        NEWS_SVC[News Service]
        ARCHIVE_SVC[Archive Service]
        CHATBOT_SVC[Chatbot Service<br/>RAG Pipeline]
    end

    subgraph "OAuth Integration"
        OAUTH_PROVIDER[OAuth Provider<br/>Google/Naver/Kakao]
        OAUTH_STATE[OAuth State Service<br/>Redis 기반]
    end

    subgraph "Domain Layer - Command Side"
        AURORA_DOMAIN[Domain Aurora<br/>JPA + MyBatis<br/>TSID Primary Key]
        AURORA_REPO[Repository<br/>Writer/Reader]
    end

    subgraph "Domain Layer - Query Side"
        MONGO_DOMAIN[Domain MongoDB<br/>Spring Data MongoDB<br/>Vector Search]
        MONGO_REPO[Repository<br/>읽기 최적화]
    end

    subgraph "Event Layer - CQRS Synchronization"
        KAFKA_PUB[Event Publisher<br/>Kafka Producer]
        KAFKA_BROKER[Apache Kafka<br/>Event Broker<br/>Topics:<br/>- user-events<br/>- archive-events<br/>- conversation-events<br/>- contest-events<br/>- news-events]
        KAFKA_CONS[Event Consumer<br/>Kafka Consumer<br/>멱등성 보장]
    end

    subgraph "RAG System"
        LANGCHAIN4J[LangChain4j<br/>RAG Framework]
        EMBEDDING[OpenAI Embedding<br/>text-embedding-3-small]
        LLM[OpenAI LLM<br/>GPT-4o-mini]
        VECTOR_SEARCH[MongoDB Atlas<br/>Vector Search<br/>Contest/News/Archive]
    end

    subgraph "Command Side Database"
        AURORA[(Amazon Aurora MySQL<br/>Command Side<br/>TSID Primary Key<br/>높은 정규화 3NF<br/>Soft Delete<br/>History Tables)]
        AURORA_WRITER[Aurora Writer<br/>Endpoint]
        AURORA_READER[Aurora Reader<br/>Endpoint]
    end

    subgraph "Query Side Database"
        MONGO[(MongoDB Atlas<br/>Query Side<br/>읽기 최적화<br/>비정규화 구조<br/>Vector Search<br/>ESR 인덱스)]
    end

    subgraph "Cache Layer"
        REDIS[(Redis<br/>캐싱<br/>OAuth State<br/>멱등성 보장<br/>세션 관리<br/>TTL: 7 days)]
    end

    subgraph "External Services"
        SLACK[Slack API<br/>알림]
        FEIGN[OpenFeign<br/>외부 API<br/>OAuth Provider API]
        RSS[RSS Parser]
        SCRAPER[Web Scraper]
    end

    subgraph "Batch Layer"
        BATCH[Spring Batch<br/>정보 출처 업데이트<br/>AI LLM 통합]
        AI_LLM[AI LLM<br/>Anthropic Claude]
    end

    %% Client to Gateway
    WEB --> GATEWAY
    MOBILE --> GATEWAY

    %% Gateway to APIs
    GATEWAY --> AUTH_API
    GATEWAY --> CONTEST_API
    GATEWAY --> NEWS_API
    GATEWAY --> ARCHIVE_API
    GATEWAY --> CHATBOT_API

    %% API to Service
    AUTH_API --> AUTH_SVC
    CONTEST_API --> CONTEST_SVC
    NEWS_API --> NEWS_SVC
    ARCHIVE_API --> ARCHIVE_SVC
    CHATBOT_API --> CHATBOT_SVC

    %% OAuth Integration
    AUTH_SVC --> OAUTH_PROVIDER
    OAUTH_PROVIDER --> OAUTH_STATE
    OAUTH_STATE --> REDIS
    OAUTH_PROVIDER --> FEIGN
    FEIGN --> OAUTH_PROVIDER

    %% Service to Domain (Command Side)
    AUTH_SVC --> AURORA_DOMAIN
    ARCHIVE_SVC --> AURORA_DOMAIN
    AURORA_DOMAIN --> AURORA_REPO
    AURORA_REPO --> AURORA_WRITER
    AURORA_REPO --> AURORA_READER
    AURORA_WRITER --> AURORA
    AURORA_READER --> AURORA

    %% Service to Domain (Query Side)
    CONTEST_SVC --> MONGO_DOMAIN
    NEWS_SVC --> MONGO_DOMAIN
    ARCHIVE_SVC --> MONGO_DOMAIN
    CHATBOT_SVC --> MONGO_DOMAIN
    MONGO_DOMAIN --> MONGO_REPO
    MONGO_REPO --> MONGO

    %% RAG System Integration
    CHATBOT_SVC --> LANGCHAIN4J
    LANGCHAIN4J --> EMBEDDING
    LANGCHAIN4J --> LLM
    CHATBOT_SVC --> VECTOR_SEARCH
    VECTOR_SEARCH --> MONGO
    LANGCHAIN4J --> VECTOR_SEARCH

    %% Command Side to Kafka
    AURORA_DOMAIN --> KAFKA_PUB
    KAFKA_PUB --> KAFKA_BROKER

    %% Kafka to Query Side
    KAFKA_BROKER --> KAFKA_CONS
    KAFKA_CONS --> MONGO_DOMAIN

    %% Redis for caching and idempotency
    KAFKA_CONS --> REDIS
    AUTH_SVC --> REDIS
    CONTEST_SVC --> REDIS
    NEWS_SVC --> REDIS
    ARCHIVE_SVC --> REDIS
    CHATBOT_SVC --> REDIS

    %% External Services
    CONTEST_SVC --> FEIGN
    NEWS_SVC --> FEIGN
    NEWS_SVC --> RSS
    NEWS_SVC --> SCRAPER
    BATCH --> SLACK
    BATCH --> AI_LLM

    %% Batch to Command Side
    BATCH --> AURORA_DOMAIN

    %% Styling
    style AURORA fill:#eff6ff,stroke:#1e3a8a,stroke-width:3px,color:#1e3a8a
    style MONGO fill:#f0fdf4,stroke:#166534,stroke-width:3px,color:#166534
    style KAFKA_BROKER fill:#fef3c7,stroke:#d97706,stroke-width:3px,color:#92400e
    style REDIS fill:#fee2e2,stroke:#dc2626,stroke-width:2px,color:#991b1b
    style AURORA_DOMAIN fill:#dbeafe,stroke:#3b82f6,stroke-width:2px,color:#1e3a8a
    style MONGO_DOMAIN fill:#dcfce7,stroke:#22c55e,stroke-width:2px,color:#166534
    style KAFKA_PUB fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#92400e
    style KAFKA_CONS fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#92400e
    style GATEWAY fill:#e0e7ff,stroke:#6366f1,stroke-width:2px,color:#312e81
    style AUTH_API fill:#e0e7ff,stroke:#6366f1,stroke-width:2px,color:#312e81
    style CONTEST_API fill:#e0e7ff,stroke:#6366f1,stroke-width:2px,color:#312e81
    style NEWS_API fill:#e0e7ff,stroke:#6366f1,stroke-width:2px,color:#312e81
    style ARCHIVE_API fill:#e0e7ff,stroke:#6366f1,stroke-width:2px,color:#312e81
    style CHATBOT_API fill:#e0e7ff,stroke:#6366f1,stroke-width:2px,color:#312e81
    style BATCH fill:#f3e8ff,stroke:#9333ea,stroke-width:2px,color:#581c87
    style OAUTH_PROVIDER fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#92400e
    style LANGCHAIN4J fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#92400e
    style EMBEDDING fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#92400e
    style LLM fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#92400e
    style VECTOR_SEARCH fill:#dcfce7,stroke:#22c55e,stroke-width:2px,color:#166534

