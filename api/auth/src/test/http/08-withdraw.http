###
# DELETE /api/v1/auth/me - 회원탈퇴 API 테스트
# Description: 현재 인증된 사용자의 계정을 탈퇴 처리 (Soft Delete)
# Note: Authorization 헤더에 Access Token 필요
###

### 사전 준비: 로그인하여 토큰 받기
POST {{baseUrl}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "{{testEmail}}",
  "password": "{{testPassword}}"
}

> {%
    client.global.set("accessToken", response.body.data.accessToken);
    client.global.set("refreshToken", response.body.data.refreshToken);
%}

### 1. 회원탈퇴 (비밀번호 확인 없음)
DELETE {{baseUrl}}/api/v1/auth/me
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "reason": "서비스 불만족"
}

> {%
    client.test("회원탈퇴 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.success === true, "success 필드가 true여야 합니다");
    });
    
    // 탈퇴 후 토큰 제거
    client.global.clear("accessToken");
    client.global.clear("refreshToken");
%}

### 2. 회원탈퇴 (비밀번호 확인 포함)
POST {{baseUrl}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "{{testEmail}}",
  "password": "{{testPassword}}"
}

> {%
    client.global.set("accessToken", response.body.data.accessToken);
%}

DELETE {{baseUrl}}/api/v1/auth/me
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "password": "{{testPassword}}",
  "reason": "서비스 불만족"
}

> {%
    client.test("회원탈퇴 성공 (비밀번호 확인)", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.success === true, "success 필드가 true여야 합니다");
    });
    
    // 탈퇴 후 토큰 제거
    client.global.clear("accessToken");
    client.global.clear("refreshToken");
%}

### 3. 실패 케이스 - 인증 없음
DELETE {{baseUrl}}/api/v1/auth/me
Content-Type: application/json

{
  "reason": "서비스 불만족"
}

> {%
    client.test("인증 실패", function() {
        client.assert(response.status === 401 || response.status === 403, "응답 상태 코드가 401 또는 403이어야 합니다");
    });
%}

### 4. 실패 케이스 - 잘못된 Access Token
DELETE {{baseUrl}}/api/v1/auth/me
Authorization: Bearer invalid_token
Content-Type: application/json

{
  "reason": "서비스 불만족"
}

> {%
    client.test("인증 실패", function() {
        client.assert(response.status === 401, "응답 상태 코드가 401이어야 합니다");
    });
%}

### 5. 실패 케이스 - 비밀번호 불일치
POST {{baseUrl}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "{{testEmail}}",
  "password": "{{testPassword}}"
}

> {%
    client.global.set("accessToken", response.body.data.accessToken);
%}

DELETE {{baseUrl}}/api/v1/auth/me
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "password": "wrongPassword",
  "reason": "서비스 불만족"
}

> {%
    client.test("비밀번호 불일치", function() {
        client.assert(response.status === 401, "응답 상태 코드가 401이어야 합니다");
    });
%}
