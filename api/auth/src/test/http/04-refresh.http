###
# POST /api/v1/auth/refresh - 토큰 갱신 API 테스트
# Description: Refresh Token으로 새로운 Access Token과 Refresh Token 발급
###

### 사전 준비: 로그인하여 토큰 받기
POST {{baseUrl}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "{{testEmail}}",
  "password": "{{testPassword}}"
}

> {%
    client.global.set("accessToken", response.body.data.accessToken);
    client.global.set("refreshToken", response.body.data.refreshToken);
%}

### 1. 정상적인 토큰 갱신
POST {{baseUrl}}/api/v1/auth/refresh
Content-Type: application/json

{
  "refreshToken": "{{refreshToken}}"
}

> {%
    client.test("토큰 갱신 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code 필드가 2000이어야 합니다");
    });
    
    client.test("새 토큰 발급 확인", function() {
        var data = response.body.data;
        client.assert(data.accessToken !== undefined, "새 accessToken이 존재해야 합니다");
        client.assert(data.refreshToken !== undefined, "새 refreshToken이 존재해야 합니다");
        
        // 새 토큰으로 업데이트
        client.global.set("accessToken", data.accessToken);
        client.global.set("refreshToken", data.refreshToken);
    });
%}

### 2. 실패 케이스 - Refresh Token 누락
POST {{baseUrl}}/api/v1/auth/refresh
Content-Type: application/json

{
}

> {%
    client.test("유효성 검증 실패", function() {
        client.assert(response.status === 400, "응답 상태 코드가 400이어야 합니다");
    });
%}

### 3. 실패 케이스 - 빈 Refresh Token
POST {{baseUrl}}/api/v1/auth/refresh
Content-Type: application/json

{
  "refreshToken": ""
}

> {%
    client.test("유효성 검증 실패", function() {
        client.assert(response.status === 400, "응답 상태 코드가 400이어야 합니다");
    });
%}

### 4. 실패 케이스 - 잘못된 Refresh Token
POST {{baseUrl}}/api/v1/auth/refresh
Content-Type: application/json

{
  "refreshToken": "invalid_refresh_token"
}

> {%
    client.test("토큰 검증 실패", function() {
        client.assert(response.status === 401, "응답 상태 코드가 401이어야 합니다");
    });
%}

### 5. 연속 토큰 갱신 테스트 - 첫 번째 갱신
POST {{baseUrl}}/api/v1/auth/refresh
Content-Type: application/json

{
  "refreshToken": "{{refreshToken}}"
}

> {%
    client.test("첫 번째 토큰 갱신 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        // 새 토큰으로 업데이트
        client.global.set("accessToken", response.body.data.accessToken);
        client.global.set("refreshToken", response.body.data.refreshToken);
    });
%}

### 6. 연속 토큰 갱신 테스트 - 두 번째 갱신
POST {{baseUrl}}/api/v1/auth/refresh
Content-Type: application/json

{
  "refreshToken": "{{refreshToken}}"
}

> {%
    client.test("두 번째 토큰 갱신 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        // 새 토큰으로 업데이트
        client.global.set("accessToken", response.body.data.accessToken);
        client.global.set("refreshToken", response.body.data.refreshToken);
    });
%}
