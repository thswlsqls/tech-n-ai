###
# POST /api/v1/agent/run - Agent 조회 Tool 및 Slack Mock 테스트
# Description: Agent의 목록 조회(list_emerging_techs), 상세 조회(get_emerging_tech_detail) Tool 및 Slack Mock 동작 테스트
# Authentication: Gateway에서 JWT ADMIN 역할 검증 후 x-user-id 헤더 주입
# @no-cookie-jar
###

### ============================================
### 목록 조회 Tool 테스트 (list_emerging_techs)
### ============================================

### 1. 목록 조회 - 기본 목록 조회 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "수집된 Emerging Tech 목록을 보여주세요."
}

> {%
    client.test("기본 목록 조회 요청 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });

    client.test("목록 조회 - AgentExecutionResult 구조 확인", function() {
        var data = response.body.data;
        client.assert(typeof data.success === "boolean", "success가 boolean이어야 합니다");
        client.assert(typeof data.summary === "string", "summary가 문자열이어야 합니다");
        client.assert(typeof data.toolCallCount === "number", "toolCallCount가 숫자여야 합니다");
    });
%}

### 2. 목록 조회 - Provider 필터 조회 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "ANTHROPIC의 Emerging Tech 목록을 보여주세요."
}

> {%
    client.test("Provider 필터 목록 조회 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });
%}

### 3. 목록 조회 - 기간 필터 조회 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "최근 1주일간 수집된 Emerging Tech 목록을 보여주세요."
}

> {%
    client.test("기간 필터 목록 조회 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });
%}

### 4. 목록 조회 - Provider + UpdateType 복합 필터 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "OPENAI의 SDK_RELEASE 목록을 최신순으로 보여주세요."
}

> {%
    client.test("Provider + UpdateType 복합 필터 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });
%}

### 5. 목록 조회 - SourceType 필터 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "GITHUB_RELEASE sourceType의 Emerging Tech 목록을 보여주세요."
}

> {%
    client.test("SourceType 필터 목록 조회 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });
%}

### 6. 목록 조회 - 기간 + Provider + UpdateType + SourceType 복합 필터
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "2025년 1월부터 현재까지 ANTHROPIC의 BLOG_POST이면서 WEB_SCRAPING으로 수집된 목록을 보여주세요."
}

> {%
    client.test("모든 필터 복합 목록 조회 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });
%}

### 7. 목록 조회 - 페이지 크기 지정 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "Emerging Tech 목록을 5건만 보여주세요."
}

> {%
    client.test("페이지 크기 지정 목록 조회 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });
%}

### 8. 목록 조회 - Status 필터 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "PUBLISHED 상태의 Emerging Tech 목록을 보여주세요."
}

> {%
    client.test("Status 필터 목록 조회 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });
%}

### ============================================
### 상세 조회 Tool 테스트 (get_emerging_tech_detail)
### ============================================

### 9. 상세 조회 - 목록에서 특정 항목 상세 조회 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "Emerging Tech 목록을 1건 조회하고, 그 항목의 상세 정보를 보여주세요."
}

> {%
    client.test("목록 → 상세 조회 요청 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });

    client.test("상세 조회 - 데이터 구조 확인", function() {
        var data = response.body.data;
        client.assert(typeof data.success === "boolean", "success가 boolean이어야 합니다");
        client.assert(typeof data.summary === "string", "summary가 문자열이어야 합니다");
        client.assert(typeof data.toolCallCount === "number", "toolCallCount가 숫자여야 합니다");
    });
%}

### 10. 상세 조회 - 검색 후 상세 조회 연계 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "Claude 관련 데이터를 검색하고, 첫 번째 결과의 상세 정보를 보여주세요."
}

> {%
    client.test("검색 → 상세 조회 연계 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });
%}

### ============================================
### Slack Mock 동작 테스트
### ============================================

### 11. Slack Mock - 알림 전송 요청 (비활성화 상태)
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "현재 수집 현황을 요약해서 Slack으로 보내주세요."
}

> {%
    client.test("Slack Mock 알림 요청 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });

    client.test("Slack Mock - Agent 내부 실패 없이 처리됨", function() {
        var data = response.body.data;
        client.assert(typeof data.success === "boolean", "success가 boolean이어야 합니다");
        client.assert(typeof data.summary === "string", "summary가 문자열이어야 합니다");
    });
%}

### 12. Slack Mock - 목록 조회 후 Slack 전송 복합 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "이번 달 OPENAI의 업데이트 목록을 조회하고, 요약 결과를 Slack으로 보내주세요."
}

> {%
    client.test("목록 조회 + Slack 복합 요청 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });

    client.test("복합 요청 - 데이터 구조 확인", function() {
        var data = response.body.data;
        client.assert(typeof data.toolCallCount === "number", "toolCallCount가 숫자여야 합니다");
        client.assert(Array.isArray(data.errors), "errors가 배열이어야 합니다");
    });
%}

### ============================================
### 목록 + 상세 + 분석 복합 시나리오 테스트
### ============================================

### 13. 복합 시나리오 - 목록 조회 → 상세 조회 → 통계 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "최근 1주일간 ANTHROPIC 업데이트를 목록으로 보여주고, 첫 번째 항목의 상세 정보도 보여주세요. 마지막으로 Provider별 통계도 함께 보여주세요."
}

> {%
    client.test("목록 + 상세 + 통계 복합 시나리오 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });

    client.test("복합 시나리오 - 다수 Tool 호출 확인", function() {
        var data = response.body.data;
        client.assert(typeof data.toolCallCount === "number", "toolCallCount가 숫자여야 합니다");
    });
%}

### 14. 복합 시나리오 - 수집 → 목록 조회 → Slack 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "OpenAI의 최신 RSS 피드를 수집하고, OPENAI의 전체 목록을 보여준 뒤, 요약 결과를 Slack으로 알려주세요."
}

> {%
    client.test("수집 + 목록 + Slack 복합 시나리오 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });
%}
