###
# POST /api/v1/agent/run - Agent 데이터 수집 Tool 테스트
# Description: Agent의 데이터 수집 Tool(collect_github_releases, collect_rss_feeds, collect_scraped_articles) 테스트
# Authentication: Gateway에서 JWT ADMIN 역할 검증 후 x-user-id 헤더 주입
# @no-cookie-jar
###

### ============================================
### 데이터 수집 Tool 테스트 (collect_*)
### ============================================

### 1. 데이터 수집 - GitHub 릴리스 수집 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "OpenAI의 openai-python 저장소 최신 릴리스를 수집하여 DB에 저장해주세요."
}

> {%
    client.test("GitHub 릴리스 수집 요청 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });

    client.test("수집 결과 구조 확인", function() {
        var data = response.body.data;
        client.assert(typeof data.success === "boolean", "success가 boolean이어야 합니다");
        client.assert(typeof data.summary === "string", "summary가 문자열이어야 합니다");
    });
%}

### 2. 데이터 수집 - RSS 피드 수집 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "OpenAI 블로그 RSS 피드를 수집하여 DB에 저장해주세요."
}

> {%
    client.test("RSS 피드 수집 요청 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });
%}

### 3. 데이터 수집 - 웹 스크래핑 수집 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "Anthropic 기술 블로그를 크롤링하여 DB에 저장해주세요."
}

> {%
    client.test("웹 스크래핑 수집 요청 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });
%}

### 4. 데이터 수집 - 전체 소스 수집 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "모든 소스(GitHub, RSS, 웹 크롤링)에서 최신 데이터를 수집하여 DB에 저장해주세요."
}

> {%
    client.test("전체 소스 수집 요청 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });

    client.test("전체 수집 - 데이터 구조 확인", function() {
        var data = response.body.data;
        client.assert(typeof data.success === "boolean", "success가 boolean이어야 합니다");
        client.assert(typeof data.summary === "string", "summary가 문자열이어야 합니다");
        client.assert(typeof data.toolCallCount === "number", "toolCallCount가 숫자여야 합니다");
    });
%}

### 5. 데이터 수집 후 통계 확인 - 수집 → 분석 복합 요청
POST {{gatewayUrl}}/api/v1/agent/run
Content-Type: application/json
x-user-id: {{adminId}}
Authorization: Bearer {{adminAccessToken}}

{
  "goal": "Anthropic의 최신 GitHub 릴리스를 수집하고, 전체 Provider별 통계도 보여주세요."
}

> {%
    client.test("수집 + 분석 복합 요청 성공", function() {
        client.assert(response.status === 200, "응답 상태 코드가 200이어야 합니다");
        client.assert(response.body.code === "2000", "code가 2000이어야 합니다");
    });
%}
